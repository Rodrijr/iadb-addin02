<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Contoso Task Pane Add-in</title>

    <!-- Office JavaScript API -->
    <script src="https://alcdn.msauth.net/browser/2.16.1/js/msal-browser.min.js"></script>
    <script type="text/javascript" src="https://appsforoffice.microsoft.com/lib/1.1/hosted/office.js"></script>

    <!-- Fluent UI -->
    <link rel="stylesheet"
        href="https://static2.sharepointonline.com/files/fabric/office-ui-fabric-core/11.0.0/css/fabric.min.css" />

    <script>
        let msalInstance;
        var msalConfig;
        const redirectURL = 'https://iadbdev.service-now.com/x_nuvo_eam_fm_view_v2.do?app=user#?"'
        // const redirectURL = `https://dev219430.service-now.com/test_01.do`
        Office.onReady(async (info) => {

            if (info.host === Office.HostType.Outlook) {
                //Office.context.ui.messageParent(JSON.stringify({ message: 'Autenticación exitosa', name: 'Usuario' }));
                login();
            }
        });

        function userSignedIn() {
            Office.context.ui.messageParent(true.toString());
        }

        function processMessage(arg) {
            //document.getElementById("status").innerText = "Versión de Outlook 888: " + outlookVersion;
            console.log("aaaaaaaaaaaaaaaa")
            var el = document.createElement("iframe");

            el.id = 'miIframe';
            el.sandbox = "allow-scripts allow-same-origin allow-top-navigation-by-user-activation allow-scripts allow-forms allow-same-origin allow-popups allow-popups-to-escape-sandbox allow-modals allow-downloads allow-storage-access-by-user-activation";

            title = "Complemento de Office Locations finder"
            allow = ""
            el.name = "{&quot;baseFrameName&quot;:&quot;_xdm_5__8b7c90dc-80fd-0982-441d-9faa8998d12269854040_b7b7b150_1724265576652&quot;,&quot;hostInfo&quot;:&quot;Outlook|Web|16.01|es-ES|9c8bc367-191e-711c-b1d0-809b38add415|||16&quot;,&quot;xdmInfo&quot;:&quot;9edc182_813dbe25_1724265576652|8b7c90dc-80fd-0982-441d-9faa8998d122|https://outlook.office.com&quot;,&quot;flights&quot;:&quot;[\&quot;Microsoft.Office.SharedOnline.ProcessMultipleCommandsInDequeInvoker\&quot;]&quot;,&quot;disabledChangeGates&quot;:&quot;[]&quot;}"
            el.class = "AddinIframe"
            el.style = "height:100vh;width:100vw;";
            el.referrerpolicy = "strict-origin-when-cross-origin";
            el.src = redirectURL;
            var a = document.getElementById("miIframe")?.remove();

            document.getElementById("taskpane-container").appendChild(el);
        }


        var dialog;
        function login() {
            const outlookVersion = Office.context.mailbox.diagnostics.hostVersion;
            console.log("Versión de Outlook:", outlookVersion);
            document.getElementById("taskpane-container").innerText = "Versión de Outlook: " + outlookVersion;
            if(outlookVersion[0] == '1'){
                 window.location.href = 'https://iadbdev.service-now.com/x_nuvo_eam_microsoft_add_in.do'
            }
            else{
                Office.context.ui.displayDialogAsync(redirectURL, { height: 30, width: 20 },
                    (asyncResult) => {
                        dialog = asyncResult.value;
                        dialog.addEventHandler(Office.EventType.DialogMessageReceived, (arg) => {
                            document.getElementById("taskpane-container").innerText = "Versión de Outlook 1 : " + outlookVersion;
                            processMessage(arg); // Llama a la función para procesar el mensaje
                        });
                        dialog.addEventHandler(Office.EventType.DialogEventReceived, (arg) => {
                            document.getElementById("taskpane-container").innerText = "Versión de Outlook 2 : ";
                            document.getElementById("taskpane-container").innerText = "Versión de Outlook 3: " + outlookVersion;
                            console.log("aaaaaaaaaaaaaaaa")
                            var el = document.createElement("iframe");

                            el.id = 'miIframe';
                            el.sandbox = "allow-scripts allow-same-origin allow-top-navigation-by-user-activation allow-scripts allow-forms allow-same-origin allow-popups allow-popups-to-escape-sandbox allow-modals allow-downloads allow-storage-access-by-user-activation";

                            title = "Complemento de Office Locations finder"
                            allow = ""
                            el.name = "{&quot;baseFrameName&quot;:&quot;_xdm_5__8b7c90dc-80fd-0982-441d-9faa8998d12269854040_b7b7b150_1724265576652&quot;,&quot;hostInfo&quot;:&quot;Outlook|Web|16.01|es-ES|9c8bc367-191e-711c-b1d0-809b38add415|||16&quot;,&quot;xdmInfo&quot;:&quot;9edc182_813dbe25_1724265576652|8b7c90dc-80fd-0982-441d-9faa8998d122|https://outlook.office.com&quot;,&quot;flights&quot;:&quot;[\&quot;Microsoft.Office.SharedOnline.ProcessMultipleCommandsInDequeInvoker\&quot;]&quot;,&quot;disabledChangeGates&quot;:&quot;[]&quot;}"
                            el.class = "AddinIframe"
                             el.style = "height:100vh;width:100vw;";
                            el.referrerpolicy = "strict-origin-when-cross-origin";
                            el.src = redirectURL;
                            var a = document.getElementById("miIframe")?.remove();

                            document.getElementById("taskpane-container").appendChild(el);
                        });
                    }
                );
            }
          /*
*/
            // window.location.href = 'https://dev219430.service-now.com/test_add_in.do'
            /*var newWindow = window.open('https://dev219430.service-now.com/test_01.do');
            var counter = 20
            var interval = setInterval(function () {
                counter -= 1;
                if (counter === 0) {
                    // newWindow.close();
                    clearInterval(interval);
                }
            }, 1000);
            window.addEventListener('message', function (event) {
                console.log("recepcion de mensaje", event)
                console.log('recibi el mensaje')
                // newWindow.close()
                // Procesar el mensaje recibido

                // Redirigir la página a test_01 con el token en la URL (o cualquier otra acción que desees)
                processMessage(newWindow)
                //window.location.href = 'https://dev219430.service-now.com/test_01.do';

            }, false);*/
            /* if (outlookVersion == 'Antigua') {
                 var newWindow = window.open('https://dev219430.service-now.com/test_01.do');
                 var counter = 20
                 var interval = setInterval(function () {
                     counter -= 1;
                     if (counter === 0) {
                         // newWindow.close();
                         clearInterval(interval);
                     }
                 }, 1000);
                 window.addEventListener('message', function (event) {
                     console.log("recepcion de mensaje", event)
                     console.log('recibi el mensaje')
                    // newWindow.close()
                     // Procesar el mensaje recibido

                     // Redirigir la página a test_01 con el token en la URL (o cualquier otra acción que desees)
                     processMessage(newWindow)
                     //window.location.href = 'https://dev219430.service-now.com/test_01.do';

                 }, false);
             }
             else if (outlookVersion == 'Nueva') {
                 Office.context.ui.displayDialogAsync(redirectURL, { height: 30, width: 20 },
                     (asyncResult) => {
                         dialog = asyncResult.value;
                         document.getElementById('status').innerText = "2";
                         dialog.addEventHandler(Office.EventType.DialogMessageReceived, (arg) => {
                             processMessage(dialog); // Llama a la función para procesar el mensaje
                         });
                         dialog.addEventHandler(Office.EventType.DialogEventReceived, (arg) => {
                             processMessage(dialog);
                         });
                     }
                 );
             }*/
        }
    </script>
</head>

<body class="ms-font-m ms-welcome ms-Fabric">
    <div id="taskpane-container">
        <div id="status"></div> <!-- Elemento para mostrar el estado de inicio de sesión -->
    </div>
    <div id="taskpane-container1">
        <iframe src="" id="miIframe"></iframe>
    </div>
</body>

</html>